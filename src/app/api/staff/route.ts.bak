import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { createAdminClient } from "@/lib/supabase/admin";
import {
  generatePasscode,
  isValidPasscode,
  normalizePhone,
} from "@/lib/staff-utils";

type StaffRole = "worker" | "manager";

type CreateStaffBody = {
  first_name?: string;
  last_name?: string;
  phone?: string;
  role?: StaffRole;
  email?: string;
  passcode?: string;
};

function jsonNoStore(payload: Record<string, unknown>, status: number) {
  return NextResponse.json(payload, {
    status,
    headers: {
      "Cache-Control": "no-store, max-age=0",
      Pragma: "no-cache",
    },
  });
}

function formatSupabaseError(error: {
  message: string;
  details?: string | null;
  hint?: string | null;
}) {
  const parts = [error.message];
  if (error.details) parts.push(error.details);
  if (error.hint) parts.push(`Hint: ${error.hint}`);
  return parts.join(" ");
}

function normalizeEmail(input: string): string | null {
  const email = input.trim().toLowerCase();
  if (!email) return null;
  const valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  return valid ? email : null;
}

function internalEmailFor(phone: string): string {
  const digits = phone.replace(/\D/g, "");
  const random = crypto.randomUUID().split("-")[0];
  return `staff-${digits}-${random}@internal.crewclock.local`;
}

async function getManagerContext() {
  const sessionClient = await createClient();

  const {
    data: { user },
  } = await sessionClient.auth.getUser();

  if (!user) {
    return { error: NextResponse.json({ error: "Unauthorized" }, { status: 401 }) };
  }

  const { data: actorProfile, error: profileError } = await sessionClient
    .from("profiles")
    .select("id, company_id, role")
    .eq("id", user.id)
    .single();

  if (profileError || !actorProfile) {
    return {
      error: NextResponse.json(
        { error: "Unable to load your profile." },
        { status: 403 }
      ),
    };
  }

  if (actorProfile.role !== "manager" && actorProfile.role !== "admin") {
    return {
      error: NextResponse.json(
        { error: "Manager or admin access required." },
        { status: 403 }
      ),
    };
  }

  return { sessionClient, actorProfile };
}

export async function POST(request: Request) {
  const context = await getManagerContext();
  if ("error" in context) return context.error;

  const { sessionClient, actorProfile } = context;
  const admin = createAdminClient();

  const body = (await request.json().catch(() => ({}))) as CreateStaffBody;

  const firstName = (body.first_name ?? "").trim();
  const lastName = (body.last_name ?? "").trim();
  const phone = normalizePhone(body.phone ?? "");
  const role = body.role;
  const providedPasscode = (body.passcode ?? "").trim();

  if (!firstName || !lastName || !phone || (role !== "worker" && role !== "manager")) {
    return jsonNoStore(
      { error: "First name, last name, phone, and valid role are required." },
      400
    );
  }

  const managerEmail = role === "manager" ? normalizeEmail(body.email ?? "") : null;
  if (role === "manager" && (body.email ?? "").trim() && !managerEmail) {
    return jsonNoStore(
      { error: "Manager email is invalid." },
      400
    );
  }

  const passcode = providedPasscode || generatePasscode();
  if (!isValidPasscode(passcode)) {
    return jsonNoStore(
      { error: "Passcode must be exactly 6 digits." },
      400
    );
  }

  const email = managerEmail ?? internalEmailFor(phone);

  const { data: created, error: createError } = await admin.auth.admin.createUser({
    email,
    password: passcode,
    email_confirm: true,
    user_metadata: {
      company_id: actorProfile.company_id,
      first_name: firstName,
      last_name: lastName,
      phone,
      role,
    },
  });

  if (createError || !created.user) {
    return jsonNoStore(
      { error: createError?.message ?? "Failed to create staff account." },
      400
    );
  }

  const createdUserId = created.user.id;

  // IMPORTANT: use session-bound client for RPC so auth.uid() is the requester.
  console.info("[staff.create] set_staff_passcode via session client", {
    requester_id: actorProfile.id,
    target_user_id: createdUserId,
  });
  const { error: passcodeError } = await sessionClient.rpc("set_staff_passcode", {
    p_user_id: createdUserId,
    p_phone: phone,
    p_passcode: passcode,
  });

  if (passcodeError) {
    await admin.auth.admin.deleteUser(createdUserId);
    return jsonNoStore(
      { error: formatSupabaseError(passcodeError) },
      400
    );
  }

  const { data: profile } = await admin
    .from("profiles")
    .select("id, company_id, first_name, last_name, phone, role, is_active, created_at")
    .eq("id", createdUserId)
    .single();

  return jsonNoStore(
    {
      staff: profile ?? {
        id: createdUserId,
        company_id: actorProfile.company_id,
        first_name: firstName,
        last_name: lastName,
        phone,
        role,
        is_active: true,
        created_at: new Date().toISOString(),
      },
      passcode,
      generated: !providedPasscode,
    },
    200
  );
}
